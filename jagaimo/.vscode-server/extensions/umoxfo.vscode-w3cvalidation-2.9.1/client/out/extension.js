(()=>{"use strict";var e,t,r,a={5991:(e,t,r)=>{r.r(t),r.d(t,{activate:()=>_,deactivate:()=>q});var a=r(7549),o=r(2847),n=r(5622),i=r.n(n),s=r(5747),c=r(3129),u=r(1669);const d=(0,u.promisify)(c.execFile);"darwin"===process.platform&&(0,c.execFile)("/usr/libexec/java_home",((e,t)=>process.env.JAVA_HOME=t));const l=[a.workspace.getConfiguration("vscode-w3cvalidation").get("javaHome"),process.env.JAVA_HOME,process.env.JDK_HOME];for(const e of l)e&&(process.env.PATH+=i().delimiter+i().join(e,"bin"));const p=require("https");var v=r.n(p),w=r(6417),f=r.n(w),m=r(2087),g=r.n(m);const h=(0,u.promisify)(c.execFile);var j;!function(e){e[e.UP_TO_DATE=304]="UP_TO_DATE",e[e.HAVE_UPDATE=200]="HAVE_UPDATE"}(j||(j={}));const x={host:"api.github.com",method:"HEAD",path:"/repos/validator/validator/releases/tags/war",headers:{Accept:"application/vnd.github+json","User-Agent":"VSCode/umoxfo.vscode-w3cvalidation","If-Modified-Since":a.workspace.getConfiguration("vscode-w3cvalidation").get("validator-token")}};async function y(e,t){const r=await new Promise(((t,r)=>{const a=v().request((e=>({host:"github.com",method:"HEAD",path:`/validator/validator/releases/download/war/${e}`,headers:{"User-Agent":"VSCode/umoxfo.vscode-w3cvalidation"}}))(e),(e=>{var r;return t(null!==(r=e.headers.location)&&void 0!==r?r:"")}));a.on("error",(e=>r(e))),a.end()}));return new Promise(((e,a)=>v().get(r,(r=>t(r,e))).on("error",(e=>a(e)))))}function b(e,t){const r=[],a=f().createHash("sha1");e.on("data",(e=>{r.push(e),a.update(e)})),e.on("end",(()=>t({warFile:Buffer.concat(r),warFileHash:a.digest("hex")})))}function P(e,t){e.setEncoding("utf8");let r="";e.on("data",(e=>r+=e)),e.on("end",(()=>t(r)))}async function O(){const[{warFile:e,warFileHash:t},r]=await Promise.all([y("vnu.war",b),y("vnu.war.sha1",P)]);if(t!==r)throw new Error("The downloaded file is invalid.");const a=i().join(g().tmpdir(),"vnu.war");return await s.promises.writeFile(a,e),a}async function A(e,t){return(await h("java",["-jar",`${e}/start.jar`,"--dry-run=path"],{cwd:t})).stdout.substring(4).trim()}async function k(e,t){const[r,a]=await Promise.all([O(),A(e,t)]),o=i().join(t,"webapps","vnu");return await s.promises.rmdir(o,{recursive:!0}),new Promise(((e,n)=>{(0,c.spawn)("java",["-cp",a,"org.eclipse.jetty.quickstart.PreconfigureQuickStartWar",r,o,i().join(t,"webapps","vnu.xml")],{cwd:t}).on("exit",(t=>0===t?e():n()))}))}const E=JSON.parse('{"fk":"Java runtime could not be located.","F":"Get Java Platform (JDK)","eN":"http://www.oracle.com/technetwork/java/javase/downloads/index.html","gm":"Install it and set its location using \'vscode-w3cvalidation.javaHome\' variable in VS Code settings.","bJ":"Open User Settings","X":"Open Workspace Settings","OA":"Please restart VS Code after set the Java execution path for your environment.","kq":"Restart VS Code"}');let S,T;async function _(e){try{await async function(){const{stderr:e}=await d("java",["-version"]);return e.substring(e.indexOf('"')+1,e.lastIndexOf('"'))>="1.8"?Promise.resolve():Promise.reject()}()}catch(e){await a.window.showErrorMessage(E.fk,E.F),await a.env.openExternal(a.Uri.parse(E.eN)),async function(){let e="";switch(await a.window.showInformationMessage(E.gm,E.bJ,E.X)){case E.bJ:e="workbench.action.openGlobalSettings";break;case E.X:e="workbench.action.openWorkspaceSettings";break;default:return H()}await a.commands.executeCommand(e),a.workspace.onDidChangeConfiguration((async()=>H()))}()}const t=e.asAbsolutePath(i().join("server","service")),r=i().join(t,"jetty-home"),n=i().join(t,"vnu");try{S=await async function(e,t){return await async function(e,t){const{status:r,token:o}=await async function(){return new Promise(((e,t)=>{const r=v().request(x,(r=>{switch(r.statusCode){case j.UP_TO_DATE:return e({status:j.UP_TO_DATE});case j.HAVE_UPDATE:return e({status:j.HAVE_UPDATE,token:r.headers["last-modified"]});default:return t(new Error(r.statusMessage))}}));r.on("error",(e=>t(e))),r.end()}))}();r===j.HAVE_UPDATE&&await Promise.all([a.workspace.getConfiguration("vscode-w3cvalidation").update("validator-token",o,a.ConfigurationTarget.Global),k(e,t)])}(e,t),new Promise(((r,a)=>{const o=(0,c.spawn)("java",["-jar",`${e}/start.jar`],{cwd:t});o.stderr.on("data",(e=>{e.includes("INFO:oejs.Server:main: Started")&&r(o)})),o.on("exit",(e=>{0!==e&&a(new Error("Failed to start validation server."))}))}))}(r,n)}catch(e){const t=i().join(n,"logs");try{for(const e of await s.promises.readdir(t))await s.promises.unlink(i().join(t,e))}catch(e){await s.promises.mkdir(t)}await new Promise((e=>{(0,c.spawn)("java",["-jar",`${r}/start.jar`,"--module=console-capture"],{cwd:n}).on("exit",e)}))}const u=e.asAbsolutePath(i().join("server","out","server.js")),l={run:{module:u,transport:o.TransportKind.ipc},debug:{module:u,transport:o.TransportKind.ipc,options:{execArgv:["--nolazy","--inspect=6009"]}}};T=new o.LanguageClient("w3cvalidation","HTML Validation Service",l,{documentSelector:[{language:"html"}],progressOnInitialization:!0}),T.start()}function q(){return S.kill("SIGINT"),null==T?void 0:T.stop()}async function H(){return await a.window.showInformationMessage(E.OA,E.kq),a.commands.executeCommand("workbench.action.reloadWindow")}},3129:e=>{e.exports=require("child_process")},6417:e=>{e.exports=require("crypto")},5747:e=>{e.exports=require("fs")},1631:e=>{e.exports=require("net")},2087:e=>{e.exports=require("os")},5622:e=>{e.exports=require("path")},1669:e=>{e.exports=require("util")},7549:e=>{e.exports=require("vscode")}},o={};function n(e){var t=o[e];if(void 0!==t)return t.exports;var r=o[e]={exports:{}};return a[e].call(r.exports,r,r.exports,n),r.exports}n.m=a,n.x=()=>{var e=n.O(void 0,[847],(()=>n(5991)));return n.O(e)},e=[],n.O=(t,r,a,o)=>{if(!r){var i=1/0;for(u=0;u<e.length;u++){for(var[r,a,o]=e[u],s=!0,c=0;c<r.length;c++)(!1&o||i>=o)&&Object.keys(n.O).every((e=>n.O[e](r[c])))?r.splice(c--,1):(s=!1,o<i&&(i=o));s&&(e.splice(u--,1),t=a())}return t}o=o||0;for(var u=e.length;u>0&&e[u-1][2]>o;u--)e[u]=e[u-1];e[u]=[r,a,o]},n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,r)=>(n.f[r](e,t),t)),[])),n.u=e=>e+".js",n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r={898:1},n.O.require=e=>r[e],n.f.require=(e,t)=>{r[e]||(e=>{var t=e.modules,a=e.ids,o=e.runtime;for(var i in t)n.o(t,i)&&(n.m[i]=t[i]);o&&o(n);for(var s=0;s<a.length;s++)r[a[s]]=1;n.O()})(require("./"+n.u(e)))},t=n.x,n.x=()=>(n.e(847),t());var i=n.x();module.exports=i})();
//# sourceMappingURL=extension.js.map