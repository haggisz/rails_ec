services:
  db:
    image: postgres:14-alpine
    volumes:
      - db:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=password
  web:
    build: .
    command: >
      sh -c "
      rm -fr tmp/pids/ /home/jagaimo/tmp/pids/ &&
      ./bin/dev
      "
    volumes:
      - .:/home/jagaimo
      - bundle:/usr/local/bundle
    ports:
      - "3000:3000"
    depends_on:
      - db
    user: "1000:1000"
    environment:
      USER_ID: 1000
      GROUP_ID: 1000
      TZ: Asia/Tokyo
    init: true
    secrets:
        - master_key

  js:
    build: .
    volumes:
      - .:/home/jagaimo
      - bundle:/usr/local/bundle
    tty: true
  css:
    build: .
    volumes:
      - .:/home/jagaimo
      - bundle:/usr/local/bundle
    tty: true

volumes:
  db:
  bundle:

secrets:
  master_key:
    file: ./config/master.key
